<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Freestyle – Judge Panel</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  padding: 20px;
}

h1 { margin-bottom: 2px; }

.event-info {
  margin-bottom: 18px;
}

.event-name {
  font-size: 22px;
  font-weight: 600;
}

.event-location,
.event-round {
  font-size: 16px;
  color: #aaa;
}

.judge-label {
  color: #aaa;
  margin-bottom: 16px;
  font-size: 18px;
}

input[type=text] {
  font-size: 24px;
  padding: 12px;
  width: 220px;
  text-align: center;
  border-radius: 10px;
  border: none;
}

.name-display {
  margin-top: 8px;
  font-size: 20px;
  color: #8bc34a;
  min-height: 26px;
}

.score-display {
  font-size: 96px;
  font-weight: bold;
  margin: 30px 0;
  transition: color 0.2s ease;
}

.slider {
  width: 90%;
  max-width: 420px;
  height: 26px;
  appearance: none;
  border-radius: 13px;
  background: linear-gradient(to right, #c62828, #f9a825, #2e7d32);
}

.slider::-webkit-slider-thumb {
  appearance: none;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: white;
}

.penalties {
  margin-top: 25px;
  font-size: 20px;
}

button {
  margin-top: 30px;
  font-size: 26px;
  padding: 18px 44px;
  border-radius: 14px;
  border: none;
  background: #00c853;
  color: white;
  width: 90%;
  max-width: 320px;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

button.locked {
  background: #555;
}
</style>
</head>

<body>

<div class="event-info">
  <div class="event-name" id="eventName">Loading event…</div>
  <div class="event-location" id="eventLocation"></div>
  <div class="event-round" id="eventRound"></div>
</div>

<div class="judge-label" id="judgeLabel">Judge: UNKNOWN</div>

<form id="scoreForm">

<input type="hidden" id="judge" name="entry.759726589">
<input type="hidden" id="score" name="entry.1544079831">

<h3>Competitor Number</h3>
<input type="text" name="entry.1094004330" id="competitor" required>
<div class="name-display" id="nameDisplay"></div>

<div class="score-display" id="scoreText">5.0</div>

<input class="slider" type="range"
min="0" max="10" step="0.1" value="5" id="slider">

<div class="penalties">
<h3>Penalties</h3>
<label><input type="checkbox" name="entry.753299047" value="Missed Entry (ME)"> Missed Entry (ME)</label><br>
<label><input type="checkbox" name="entry.753299047" value="Water Landing (WL)"> Water Landing (WL)</label><br>
<label><input type="checkbox" name="entry.753299047" value="Move Failure (MF)"> Move Failure (MF)</label>
</div>

<button type="button" id="submitBtn">HOLD TO SUBMIT</button>

</form>

<script>
// -------- CONFIG --------
const SHEET_ID = "1v839BJMAiCtXbSwRaS6jDq_oDxZgSYwU5sm4JwzrYUk";
const EVENT_CONFIG_GID = "686531230";
const COMPETITOR_GID = "51112637";
const FORM_ENDPOINT =
  "https://docs.google.com/forms/d/e/1FAIpQLSfb2JIBic9mirDg9_CX80br3jmQ74vaLM3BJITnUDEXfmi0pg/formResponse";

// -------- Judge ID --------
const params = new URLSearchParams(window.location.search);
const judge = params.get("judge") || "UNKNOWN";
document.getElementById("judge").value = judge;
document.getElementById("judgeLabel").innerText = "Judge: " + judge;

// -------- Event Config --------
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENT_CONFIG_GID}&tqx=out:json`)
  .then(r => r.text())
  .then(t => {
    const json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
    const config = {};
    json.table.rows.forEach(r => {
      config[r.c[0].v] = r.c[1].v;
    });

    document.getElementById("eventName").textContent = config.EventName || "";
    document.getElementById("eventLocation").textContent = config.Location || "";
    document.getElementById("eventRound").textContent = config.Round || "";
  });

// -------- Competitor Lookup --------
const competitorInput = document.getElementById("competitor");
const nameDisplay = document.getElementById("nameDisplay");
let competitorMap = {};

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITOR_GID}&tqx=out:json`)
  .then(r => r.text())
  .then(t => {
    const json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
    json.table.rows.forEach(r => {
      competitorMap[r.c[0].v] = r.c[1].v;
    });
  });

competitorInput.addEventListener("input", () => {
  nameDisplay.textContent =
    competitorMap[competitorInput.value] || "Unknown competitor";
});

// -------- Slider + Haptics --------
const slider = document.getElementById("slider");
const scoreText = document.getElementById("scoreText");
const scoreInput = document.getElementById("score");
let lastHaptic = 5.0;

function updateScore() {
  const val = parseFloat(slider.value).toFixed(1);
  scoreText.textContent = val;
  scoreInput.value = val;

  const hue = (val / 10) * 120;
  scoreText.style.color = `hsl(${hue}, 90%, 60%)`;

  if (Math.abs(val - lastHaptic) >= 0.5 && navigator.vibrate) {
    navigator.vibrate(10);
    lastHaptic = val;
  }
}

slider.addEventListener("input", updateScore);
updateScore();

// -------- Offline-safe submit --------
const QUEUE_KEY = "pendingSubmissions";

function getQueue() {
  return JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
}

function saveToQueue(data) {
  const q = getQueue();
  q.push(Object.fromEntries(data.entries()));
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
}

function flushQueue() {
  if (!navigator.onLine) return;
  const q = getQueue();
  if (!q.length) return;

  const remaining = [];
  q.forEach(item => {
    const fd = new FormData();
    Object.keys(item).forEach(k => fd.append(k, item[k]));
    fetch(FORM_ENDPOINT, { method: "POST", mode: "no-cors", body: fd })
      .catch(() => remaining.push(item));
  });

  localStorage.setItem(QUEUE_KEY, JSON.stringify(remaining));
}

window.addEventListener("online", flushQueue);

// -------- Short Hold Submit --------
const submitBtn = document.getElementById("submitBtn");
let locked = false;
let holdTimer;

function startHold(e) {
  if (locked) return;
  e.preventDefault();
  holdTimer = setTimeout(submitScore, 350);
}

function cancelHold() {
  clearTimeout(holdTimer);
}

function submitScore() {
  const data = new FormData(document.getElementById("scoreForm"));
  saveToQueue(data);
  flushQueue();

  if (navigator.vibrate) navigator.vibrate([25, 30, 25]);

  locked = true;
  slider.disabled = true;
  submitBtn.textContent = "READY FOR NEXT RUN";
  submitBtn.classList.add("locked");
}

submitBtn.addEventListener("touchstart", startHold, { passive: false });
submitBtn.addEventListener("touchend", cancelHold);
submitBtn.addEventListener("touchcancel", cancelHold);
submitBtn.addEventListener("mousedown", startHold);
submitBtn.addEventListener("mouseup", cancelHold);
submitBtn.addEventListener("mouseleave", cancelHold);

submitBtn.addEventListener("click", () => {
  if (!locked) return;

  locked = false;
  slider.disabled = false;
  slider.value = 5;
  lastHaptic = 5.0;
  updateScore();

  competitorInput.value = "";
  nameDisplay.textContent = "";
  document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);

  submitBtn.textContent = "HOLD TO SUBMIT";
  submitBtn.classList.remove("locked");
});
</script>

</body>
</html>
