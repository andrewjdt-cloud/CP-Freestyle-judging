<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Freestyle – Judge Panel (v1.3)</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#111;
  color:#fff;
  text-align:center;
  padding:14px;
}

/* ---------- Event Info ---------- */
.event-info { margin-bottom:10px; }
.event-name { font-size:20px; font-weight:600; }
.event-location, .event-round { font-size:14px; color:#aaa; }

.round-status { font-size:13px; margin-top:2px; }
.round-open { color:#00e676; }
.round-closed, .access-denied { color:#ff5252; }

/* ---------- Judge ---------- */
.judge-label { margin-bottom:8px; font-size:14px; color:#aaa; }

/* ---------- Navigation ---------- */
.competitor-nav {
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:10px 0;
}

.nav-btn {
  font-size:18px;
  padding:10px 14px;
  border-radius:12px;
  border:none;
  background:#222;
  color:#fff;
}
.nav-btn:disabled { opacity:0.3; }

/* ---------- Competitor ---------- */
.competitor-number { font-size:42px; font-weight:bold; }
.name-display { font-size:16px; color:#8bc34a; min-height:20px; }
.move-display {
  font-size:13px;
  color:#ccc;
  margin-top:4px;
  max-width:280px;
  margin-left:auto;
  margin-right:auto;
}

/* ---------- Success Overlay ---------- */
.success-overlay {
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:10;
}
.success-overlay.hidden { display:none; }

.success-tick {
  font-size:96px;
  color:#00e676;
  animation:tickFade 3s ease-out forwards;
}

@keyframes tickFade {
  0% { opacity:1; transform:scale(1); }
  60% { opacity:0.6; transform:scale(0.95); }
  100% { opacity:0; transform:scale(0.9); }
}

.countdown {
  font-size:72px;
  font-weight:bold;
  color:#ffeb3b;
  background:rgba(0,0,0,0.65);
  width:96px;
  height:96px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}

@keyframes pulse {
  0% { transform:scale(1); }
  40% { transform:scale(1.18); }
  100% { transform:scale(1); }
}

/* ---------- Score ---------- */
.score-display {
  font-size:80px;
  font-weight:bold;
  margin:18px 0 12px;
}

.slider {
  width:100%;
  height:22px;
  appearance:none;
  border-radius:11px;
  background:linear-gradient(to right,#c62828,#f9a825,#2e7d32);
}
.slider::-webkit-slider-thumb {
  appearance:none;
  width:36px;
  height:36px;
  border-radius:50%;
  background:#fff;
}

/* ---------- Penalties ---------- */
.penalties { margin-top:8px; font-size:16px; }
.penalty-row {
  display:flex;
  justify-content:center;
  gap:26px;
  margin-top:4px;
}

/* ---------- Submit ---------- */
button.submit {
  margin-top:12px;
  font-size:22px;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#00c853;
  color:#fff;
  width:100%;
}
button.disabled { background:#555; }
</style>
</head>

<body>

<div class="event-info">
  <div class="event-name" id="eventName">Loading event…</div>
  <div class="event-location" id="eventLocation"></div>
  <div class="event-round" id="eventRound"></div>
  <div class="round-status" id="roundStatus"></div>
</div>

<div class="judge-label" id="judgeLabel">Judge: —</div>

<form id="scoreForm">
<input type="hidden" id="judge" name="entry.759726589">
<input type="hidden" id="competitor" name="entry.1094004330">
<input type="hidden" id="score" name="entry.1544079831">

<div class="competitor-nav">
  <button type="button" class="nav-btn" id="prevBtn">◀ PREV</button>

  <div>
    <div class="competitor-number" id="competitorDisplay">—</div>
    <div class="name-display" id="nameDisplay"></div>
    <div class="move-display" id="moveDisplay"></div>
  </div>

  <button type="button" class="nav-btn" id="nextBtn">NEXT ▶</button>

  <div class="success-overlay hidden" id="successOverlay">
    <div class="success-tick">✔</div>
    <div class="countdown" id="countdownText">3</div>
  </div>
</div>

<div class="score-display" id="scoreText">5.0</div>
<input class="slider" type="range" min="0" max="10" step="0.1" value="5" id="slider">

<div class="penalties">
  <div class="penalty-row">
    <label><input type="checkbox" name="entry.753299047" value="Missed Entry (ME)"> ME</label>
    <label><input type="checkbox" name="entry.753299047" value="Water Landing (WL)"> WL</label>
    <label><input type="checkbox" name="entry.753299047" value="Move Failure (MF)"> MF</label>
  </div>
</div>

<button type="button" class="submit disabled" id="submitBtn">HOLD TO SUBMIT</button>
</form>

<script>
/* ---------- CONFIG ---------- */
const SHEET_ID="1v839BJMAiCtXbSwRaS6jDq_oDxZgSYwU5sm4JwzrYUk";
const EVENT_CONFIG_GID="686531230";
const COMPETITOR_GID="51112637";
const JUDGES_GID="1213944419";
const FORM_ENDPOINT="https://docs.google.com/forms/d/e/1FAIpQLSfb2JIBic9mirDg9_CX80br3jmQ74vaLM3BJITnUDEXfmi0pg/formResponse";

/* ---------- URL Params ---------- */
const params=new URLSearchParams(location.search);
const judgeParam=params.get("judge");
const tokenParam=params.get("token");

/* ---------- State ---------- */
let roundNumber=1;
let roundOpen=false;
let accessGranted=false;
let locked=false;
let competitors=[];
let index=0;

/* ---------- Helpers ---------- */
function haptic(p=10){ if(navigator.vibrate) navigator.vibrate(p); }
function parseGViz(t){ return JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1)); }
function headerMap(cols){
  return Object.fromEntries(cols.map((c,i)=>{
    const k=(c.label||c.id||"").toLowerCase().replace(/[^a-z0-9]/g,"");
    return [k,i];
  }));
}

/* ---------- Load Event Config ---------- */
async function loadEventConfig(){
  const j=parseGViz(await (await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENT_CONFIG_GID}&tqx=out:json`)).text());
  const cfg={};
  j.table.rows.forEach(r=>cfg[r.c[0]?.v]=r.c[1]?.v||"");

  eventName.textContent=cfg.EventName||"";
  eventLocation.textContent=cfg.Location||"";

  roundNumber=parseInt(cfg.Round,10);
  if(!Number.isInteger(roundNumber)) roundNumber=1;
  eventRound.textContent=`Round ${roundNumber}`;

  roundOpen=String(cfg.RoundOpen).toUpperCase()==="YES";
  roundStatus.textContent=roundOpen?"● OPEN":"● CLOSED";
  roundStatus.className="round-status "+(roundOpen?"round-open":"round-closed");
}

/* ---------- Judge Auth ---------- */
async function loadJudgeAuth(){
  const j=parseGViz(await (await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${JUDGES_GID}&tqx=out:json`)).text());
  const h=headerMap(j.table.cols);

  j.table.rows.forEach(r=>{
    if(
      r.c[h.judgename]?.v===judgeParam &&
      r.c[h.judgetoken]?.v===tokenParam &&
      String(r.c[h.judgeactive]?.v).toUpperCase()==="YES"
    ){
      accessGranted=true;
      judge.value=judgeParam;
      judgeLabel.textContent="Judge: "+judgeParam;
    }
  });

  if(!accessGranted){
    roundStatus.textContent="Access denied";
    roundStatus.className="round-status access-denied";
    throw new Error("Access denied");
  }
}

/* ---------- Competitors ---------- */
async function loadCompetitors(){
  const j=parseGViz(await (await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITOR_GID}&tqx=out:json`)).text());
  const h=headerMap(j.table.cols);

  competitors=j.table.rows.map(r=>({
    order:+r.c[h.competitororder]?.v||0,
    number:r.c[h.competitornumber]?.v,
    name:r.c[h.competitorname]?.v,
    moves:{
      1:r.c[h.mover1]?.v,
      2:r.c[h.mover2]?.v,
      3:r.c[h.mover3]?.v,
      4:r.c[h.mover4]?.v,
      5:r.c[h.mover5]?.v,
      6:r.c[h.mover6]?.v
    }
  })).sort((a,b)=>a.order-b.order);

  updateCompetitor();
}

/* ---------- UI ---------- */
function updateCompetitor(){
  const c=competitors[index];
  competitor.value=c.number;
  competitorDisplay.textContent=c.number;
  nameDisplay.textContent=c.name;
  moveDisplay.textContent=c.moves[roundNumber]||"";
  prevBtn.disabled=locked||index===0;
  nextBtn.disabled=locked||index===competitors.length-1;
}

/* ---------- Navigation ---------- */
prevBtn.onclick=()=>{ if(!locked&&index>0){index--;updateCompetitor();haptic(5);} };
nextBtn.onclick=()=>{ if(!locked&&index<competitors.length-1){index++;updateCompetitor();haptic(5);} };

/* ---------- Slider ---------- */
let last=5;
slider.oninput=()=>{
  const v=+slider.value;
  scoreText.textContent=v.toFixed(1);
  score.value=v.toFixed(1);
  scoreText.style.color=`hsl(${(v/10)*120},90%,60%)`;
  if(Math.abs(v-last)>=0.5){haptic(10);last=v;}
};

/* ---------- Submit ---------- */
let pressStart=null;
submitBtn.onmousedown=submitBtn.ontouchstart=e=>{
  if(!roundOpen||!accessGranted||locked) return;
  e.preventDefault(); pressStart=Date.now();
};
submitBtn.onmouseup=submitBtn.ontouchend=()=>{
  if(!pressStart) return;
  if(Date.now()-pressStart>=350) submit();
  pressStart=null;
};

function submit(){
  fetch(FORM_ENDPOINT,{method:"POST",mode:"no-cors",body:new FormData(scoreForm)});
  haptic([25,30,25]);
  locked=true;
  slider.disabled=prevBtn.disabled=nextBtn.disabled=true;
  successOverlay.classList.remove("hidden");
  startCountdown();
}

function startCountdown(){
  let n=3;
  updateCountdown(n);
  const iv=setInterval(()=>{
    n--;
    if(n===0){clearInterval(iv);resetAndAdvance();}
    else updateCountdown(n);
  },1000);
}

function updateCountdown(v){
  countdownText.textContent=v;
  countdownText.style.animation="none";
  countdownText.offsetHeight;
  countdownText.style.animation="pulse 1s ease-in-out";
}

function resetAndAdvance(){
  successOverlay.classList.add("hidden");
  locked=false;
  slider.disabled=false;
  slider.value=5;
  scoreText.textContent="5.0";
  score.value="5.0";
  document.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
  if(index<competitors.length-1) index++;
  updateCompetitor();
}

/* ---------- BOOT ---------- */
(async()=>{
  try{
    await loadEventConfig();
    await loadJudgeAuth();
    await loadCompetitors();
    submitBtn.classList.remove("disabled");
  }catch(e){
    console.error(e);
  }
})();
</script>

</body>
</html>
