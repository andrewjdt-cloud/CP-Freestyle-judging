<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Freestyle – Admin Panel</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0b0b0b;
  color: #fff;
  padding: 20px;
}

.section {
  background: #111;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 20px;
}

button {
  padding: 12px 18px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #00c853;
  color: #fff;
  cursor: pointer;
}

button.danger {
  background: #ff5252;
}

button.small {
  font-size: 14px;
  padding: 8px 12px;
}

.judge {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
}

.error {
  color: #ff5252;
}
</style>
</head>

<body>

<h2>CP Freestyle – Admin Panel</h2>

<div id="error" class="error"></div>

<div id="adminContent" style="display:none;">

  <div class="section">
    <h3>Round Control</h3>
    <button onclick="setRound('YES')">OPEN ROUND</button>
    <button class="danger" onclick="setRound('NO')">CLOSE ROUND</button>
    <div id="roundStatus"></div>
  </div>

  <div class="section">
    <h3>Judges</h3>
    <div id="judges"></div>
  </div>

</div>

<script>
/* ---------- CONFIG ---------- */
const SHEET_ID = "1v839BJMAiCtXbSwRaS6jDq_oDxZgSYwU5sm4JwzrYUk";
const EVENT_CONFIG_GID = "686531230";
const JUDGES_GID = "1213944419";

const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbx9xfxW7hyAT-3A5viq0REB2MKw4JAuBjUN4_YfHaE-kIV-G-7oLUvvaiLMtZhzYrr_/exec";

/* ---------- AUTH ---------- */
const params = new URLSearchParams(window.location.search);
const adminToken = params.get("token");

/* ---------- API CALL ---------- */
function api(payload) {
  payload.adminToken = adminToken;

  return fetch(SCRIPT_URL, {
    method: "POST",
    mode: "cors",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  }).then(r => r.json());
}

/* ---------- Load Event Config ---------- */
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENT_CONFIG_GID}&tqx=out:json`)
  .then(r => r.text())
  .then(t => {
    const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
    const cfg = {};
    j.table.rows.forEach(r => cfg[r.c[0].v] = r.c[1].v);

    if (!adminToken || cfg.AdminToken !== adminToken) {
      document.getElementById("error").textContent = "Access denied";
      return;
    }

    document.getElementById("adminContent").style.display = "block";
    document.getElementById("roundStatus").textContent =
      "Current RoundOpen: " + cfg.RoundOpen;
  });

/* ---------- Round Control ---------- */
function setRound(value) {
  api({ action: "setRoundOpen", value })
    .then(res => {
      if (res.ok) {
        document.getElementById("roundStatus").textContent =
          "Current RoundOpen: " + value;
      } else {
        alert("Error: " + res.error);
      }
    })
    .catch(err => alert("Network error"));
}

/* ---------- Load Judges ---------- */
fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${JUDGES_GID}&tqx=out:json`)
  .then(r => r.text())
  .then(t => {
    const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
    const container = document.getElementById("judges");

    j.table.rows.forEach(r => {
      const name = r.c[0].v;
      const active = r.c[2].v;

      const row = document.createElement("div");
      row.className = "judge";

      const label = document.createElement("span");
      label.textContent = name + " (" + active + ")";

      const btn = document.createElement("button");
      btn.textContent = active === "YES" ? "DISABLE" : "ENABLE";
      btn.className = "small " + (active === "YES" ? "danger" : "");

      btn.onclick = () => {
        api({
          action: "setJudgeActive",
          judge: name,
          value: active === "YES" ? "NO" : "YES"
        }).then(res => {
          if (res.ok) location.reload();
          else alert("Error: " + res.error);
        });
      };

      row.appendChild(label);
      row.appendChild(btn);
      container.appendChild(row);
    });
  });
</script>

</body>
</html>
