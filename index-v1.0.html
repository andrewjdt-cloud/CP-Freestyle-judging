<!--
CP Freestyle Judging System
File: index.html
Version: v1.0 (Phase A + schema fix)
Date: 2026-02-16
Notes:
- Manual competitor entry
- Ignores ExitOrder column
- Uses CompetitorNumber → Name
- 3–2–1 pulsing countdown + fading tick
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Freestyle – Judge Panel</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  padding: 16px;
}

/* ---------- Event Info ---------- */
.event-info { margin-bottom: 10px; }
.event-name { font-size: 20px; font-weight: 600; }
.event-location,
.event-round { font-size: 14px; color: #aaa; }

.round-status { font-size: 13px; margin-top: 2px; }
.round-open { color: #00e676; }
.round-closed,
.access-denied { color: #ff5252; }

/* ---------- Judge ---------- */
.judge-label {
  margin-bottom: 10px;
  font-size: 16px;
  color: #aaa;
}

/* ---------- Competitor ---------- */
input[type=text] {
  font-size: 22px;
  padding: 10px;
  width: 200px;
  text-align: center;
  border-radius: 10px;
  border: none;
}

.name-display {
  margin-top: 6px;
  font-size: 18px;
  color: #8bc34a;
  min-height: 22px;
}

/* ---------- Success Overlay ---------- */
.comp-wrap { position: relative; display: inline-block; }

.success-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.hidden { display: none; }

.success-tick {
  font-size: 96px;
  color: #00e676;
  animation: tickFade 3s ease-out forwards;
}

@keyframes tickFade {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

.countdown {
  font-size: 72px;
  font-weight: bold;
  color: #ffeb3b;
  background: rgba(0,0,0,0.65);
  width: 96px;
  height: 96px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

@keyframes pulse {
  0% { transform: scale(1); }
  40% { transform: scale(1.18); }
  100% { transform: scale(1); }
}

/* ---------- Score ---------- */
.score-display {
  font-size: 88px;
  font-weight: bold;
  margin: 16px 0;
}

.slider {
  width: 90%;
  max-width: 420px;
  height: 24px;
  border-radius: 12px;
}

/* ---------- Submit ---------- */
button {
  margin-top: 16px;
  font-size: 24px;
  padding: 14px 36px;
  border-radius: 14px;
  border: none;
  background: #00c853;
  color: #fff;
  width: 90%;
}
button.locked { background: #555; }
</style>
</head>

<body>

<div class="event-info">
  <div class="event-name" id="eventName">Loading…</div>
  <div class="event-location" id="eventLocation"></div>
  <div class="event-round" id="eventRound"></div>
  <div class="round-status" id="roundStatus"></div>
</div>

<div class="judge-label" id="judgeLabel">Judge: —</div>

<form id="scoreForm">
<input type="hidden" id="judge" name="entry.759726589">
<input type="hidden" id="score" name="entry.1544079831">

<div class="comp-wrap">
  <h3>Competitor</h3>
  <input type="text" id="competitor" name="entry.1094004330">
  <div class="name-display" id="nameDisplay"></div>

  <div class="success-overlay hidden" id="successOverlay">
    <div class="success-tick">✔</div>
    <div class="countdown" id="countdownText">3</div>
  </div>
</div>

<div class="score-display" id="scoreText">5.0</div>
<input type="range" min="0" max="10" step="0.1" value="5" id="slider" class="slider">

<button type="button" id="submitBtn">HOLD TO SUBMIT</button>
</form>

<script>
const SHEET_ID="1v839BJMAiCtXbSwRaS6jDq_oDxZgSYwU5sm4JwzrYUk";
const COMPETITOR_GID="51112637";
const FORM_ENDPOINT="https://docs.google.com/forms/d/e/1FAIpQLSfb2JIBic9mirDg9_CX80br3jmQ74vaLM3BJITnUDEXfmi0pg/formResponse";

const competitorMap={};

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITOR_GID}&tqx=out:json`)
.then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
  j.table.rows.forEach(r=>{
    competitorMap[r.c[1].v]=r.c[2].v; // B → C
  });
});

competitor.oninput=()=>{
  nameDisplay.textContent=competitorMap[competitor.value]||"Unknown competitor";
};

let pressStart=null;
submitBtn.onmousedown=e=>{
  if(!competitor.value) return;
  pressStart=Date.now(); e.preventDefault();
};
submitBtn.onmouseup=()=>{
  if(Date.now()-pressStart>=350) submit();
};

function submit(){
  fetch(FORM_ENDPOINT,{method:"POST",mode:"no-cors",body:new FormData(scoreForm)});
  successOverlay.classList.remove("hidden");
  startCountdown();
}

function startCountdown(){
  let n=3; pulse(n);
  const iv=setInterval(()=>{
    n--; if(n===0){clearInterval(iv); reset();}
    else pulse(n);
  },1000);
}

function pulse(n){
  countdownText.textContent=n;
  countdownText.style.animation="none";
  countdownText.offsetHeight;
  countdownText.style.animation="pulse 1s";
}

function reset(){
  successOverlay.classList.add("hidden");
  competitor.value="";
  nameDisplay.textContent="";
}
</script>
</body>
</html>
